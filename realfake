import pandas as pd
import re
import os
import matplotlib.pyplot as plt
from sklearn.model_selection import train_test_split
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.naive_bayes import MultinomialNB
from sklearn.metrics import accuracy_score, classification_report, ConfusionMatrixDisplay

# 1. ë°ì´í„° ë¡œë”© ë° ê²°í•©
df_fake = pd.read_csv("Fake.csv")
df_real = pd.read_csv("True.csv")
df_fake["label"] = 0
df_real["label"] = 1
df = pd.concat([df_fake, df_real])

# 2. í…ìŠ¤íŠ¸ ì •ì œ
def clean_text(text):
    text = text.lower()
    text = re.sub(r'[^a-zA-Z]', ' ', text)
    return text

df["clean_text"] = df["text"].apply(clean_text)

# 3. ë²¡í„°í™” ë° í•™ìŠµ
X = df["clean_text"]
y = df["label"]
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

vectorizer = TfidfVectorizer(stop_words='english', max_df=0.7)
X_train_tfidf = vectorizer.fit_transform(X_train)
X_test_tfidf = vectorizer.transform(X_test)

model = MultinomialNB()
model.fit(X_train_tfidf, y_train)
y_pred = model.predict(X_test_tfidf)

# 4. í‰ê°€
print("\nâœ… ëª¨ë¸ í‰ê°€ ê²°ê³¼:")
print(f"ì •í™•ë„: {accuracy_score(y_test, y_pred):.4f}")
print("\nğŸ“Š ë¶„ë¥˜ ë¦¬í¬íŠ¸:")
print(classification_report(y_test, y_pred, target_names=["FAKE", "REAL"]))

# 5. í˜¼ë™ í–‰ë ¬ ì €ì¥
save_path = "/Users/moonseoyeong/Documents/fake_news_project/confusion_matrix.png"
ConfusionMatrixDisplay.from_estimator(model, X_test_tfidf, y_test, display_labels=["FAKE", "REAL"], cmap="Blues")
plt.title("Confusion Matrix")
if os.path.exists(save_path):
    os.remove(save_path)
plt.savefig(save_path)
plt.close()
print(f"ğŸ“¸ ì €ì¥ ì™„ë£Œ! ì´ë¯¸ì§€ ìœ„ì¹˜: {save_path}")

# 6. ì½˜ì†” ì…ë ¥ + ëˆ„ì  íŒŒì´ì°¨íŠ¸ ì €ì¥
counter = 1
while True:
    user_input = input("\nğŸ“° íŒë³„í•  ë‰´ìŠ¤ ê¸°ì‚¬ ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš” (ì¢…ë£Œí•˜ë ¤ë©´ 'exit'): ")
    if user_input.lower() == "exit":
        break

    cleaned = clean_text(user_input)
    vec = vectorizer.transform([cleaned])
    result = model.predict(vec)
    prob = model.predict_proba(vec)[0]

    print("â†’ ì˜ˆì¸¡ ê²°ê³¼:", "ğŸŸ¢ ì§„ì§œ ë‰´ìŠ¤ì…ë‹ˆë‹¤." if result[0] == 1 else "ğŸ”´ ê°€ì§œ ë‰´ìŠ¤ì…ë‹ˆë‹¤.")
    print(f"â†’ ì˜ˆì¸¡ í™•ë¥ : FAKE={prob[0]:.2f}, REAL={prob[1]:.2f}")

    # íŒŒì´ ì°¨íŠ¸ ëˆ„ì  ì €ì¥
    labels = ['FAKE', 'REAL']
    colors = ['red', 'green']
    plt.figure(figsize=(5,5))
    plt.pie(prob, labels=labels, colors=colors, autopct='%1.1f%%', startangle=90)
    plt.title("Prediction Result")
    filename = f"predict_{counter}.png"
    plt.savefig(filename)
    plt.close()
    print(f"ğŸ“¸ ê²°ê³¼ ì´ë¯¸ì§€ ì €ì¥ ì™„ë£Œ â†’ {filename}")
    counter += 1

